## 11. Automa√ß√£o de certificados TLS (Win-ACME + PowerShell + Agendador)

Al√©m da automa√ß√£o de seguran√ßa (EventHandlers + AUTO-BLOQUEIO-Fail2Ban.ps1),
existe uma segunda automa√ß√£o em ‚Äúpiloto autom√°tico‚Äù para manter os
**certificados TLS sempre atualizados** tanto no IIS quanto no hMailServer.

Tudo √© orquestrado via:

- **Win-ACME** (`wacs.exe`, ex.: `win-acme.v2.2.9.1701.x64.trimmed`)
- **Scripts PowerShell** (exemplos):
  - `automacao-de-ce.ps1` / `post-renew.ps1`
  - `01-extract-keys.ps1`
  - `02-update-hmail.ps1`
  - `Comparar-Certificados-HMail-IIS.ps1`
- **Agendador de Tarefas do Windows**

> Importante: nenhum segredo (PFX real, senhas, chaves privadas) deve ser versionado
> no reposit√≥rio. Apenas os scripts gen√©ricos e caminhos ‚Äúmodelo‚Äù.

---

### 11.1 Objetivo da automa√ß√£o

Garantir que, sempre que o certificado Let‚Äôs Encrypt for renovado:

1. O IIS passe a usar o **novo certificado** para HTTPS.
2. O hMailServer passe a usar o **mesmo certificado** para:
   - IMAPS (993)
   - SMTP/STARTTLS (587, opcionalmente 25)
3. Sem interven√ß√£o manual, de forma repet√≠vel e audit√°vel.

Assim, tanto web (IIS) quanto e-mail (hMailServer) ficam:

- com o certificado em dia;
- com o mesmo **thumbprint**, reduzindo problemas de confian√ßa em clientes.

---

### 11.2 Fluxo l√≥gico (alto n√≠vel)

1. **Win-ACME renova o certificado**
   - O `wacs.exe` √© executado (via tarefa agendada do Windows).
   - Ao renovar com sucesso, ele dispara um ‚Äúscript p√≥s-renova√ß√£o‚Äù, por exemplo:
     - `post-renew.ps1` ou `automacao-de-ce.ps1`.

2. **Script orquestrador (automacao-de-ce.ps1 / post-renew.ps1)**
   - √â o ‚Äúpiloto autom√°tico‚Äù que chama os outros scripts em sequ√™ncia:
     1. `01-extract-keys.ps1`
     2. `02-update-hmail.ps1`
     3. `Comparar-Certificados-HMail-IIS.ps1` (verifica√ß√£o)

3. **Atualiza√ß√£o conclu√≠da**
   - IIS j√° est√° usando o novo certificado (via pr√≥prio Win-ACME).
   - hMailServer √© atualizado para usar o mesmo certificado.
   - Um relat√≥rio/log √© gerado para auditoria.

Tudo isso roda **no servidor**, sem expor nada pelo hMailServer nem
criar novas superf√≠cies de ataque.

---

### 11.3 Pap√©is dos scripts (conceito, sem detalhes sens√≠veis)

> Os nomes abaixo s√£o exemplos reais de como o fluxo foi dividido,
> mas o reposit√≥rio deve conter apenas a l√≥gica gen√©rica, sem paths secretos.

#### 11.3.1 `01-extract-keys.ps1`

Respons√°vel por:

- Localizar o certificado rec√©m-renovado no **reposit√≥rio de certificados do Windows**
  (por thumbprint, subject, etc.).
- Exportar para formatos de trabalho, por exemplo:
  - `.pfx` (com senha definida no script/vari√°vel protegida)
  - `.cer` / `.pem` para outras ferramentas se necess√°rio.
- Organizar a sa√≠da em pastas previs√≠veis, algo como:

```text
C:\Certificados\mail.seudominio.com.br\
  ‚îú‚îÄ atual\
  ‚îÇ   ‚îú‚îÄ cert.pfx
  ‚îÇ   ‚îî‚îÄ cert.cer
  ‚îî‚îÄ historico\
      ‚îî‚îÄ ... (opcional)
### 11.3.2 02-update-hmail.ps1
**Respons√°vel por:**

* Atualizar a configura√ß√£o do hMailServer para usar o novo certificado.
* Pode fazer isso via:
    * API/COM do hMailServer;
    * ou atualiza√ß√£o de path/arquivo onde o hMail busca o PFX.
* **Passos t√≠picos:**
    1.  Parar o servi√ßo do hMailServer (se necess√°rio).
    2.  Apontar a configura√ß√£o para o novo PFX ou thumbprint.
    3.  Iniciar o servi√ßo novamente.
    4.  Registrar no log o novo thumbprint/caminho em uso.

### 11.3.3 Comparar-Certificados-HMail-IIS.ps1
**Respons√°vel por:**

* Ler o certificado em uso no IIS (binding HTTPS).
* Ler o certificado em uso no hMailServer (IMAPS/SMTP).
* Comparar thumbprints.
* **Se baterem:**
    * Registrar algo como `OK: IIS e hMailServer usam o mesmo certificado`.
* **Se n√£o baterem:**
    * Registrar alerta no log (e, opcionalmente, disparar e-mail interno ou evento).

---

## 11.4 Agendador de Tarefas (Windows Task Scheduler)
Existem, tipicamente, duas tarefas relacionadas:

**1. Tarefa Win-ACME (renova√ß√£o)**
* Respons√°vel por executar o `wacs.exe` periodicamente (ex.: 1x por dia ou algumas vezes por semana).
* Configurada para:
    * Renovar certificados pr√≥ximos do vencimento.
    * Chamar o script p√≥s-renova√ß√£o (ex.: `post-renew.ps1` / `automacao-de-ce.ps1`).

**2. Tarefa auxiliar (opcional)**
* Se necess√°rio, pode haver uma tarefa separada apenas para rodar scripts de compara√ß√£o/valida√ß√£o (como `Comparar-Certificados-HMail-IIS.ps1`) em determinado hor√°rio (ex.: de madrugada) para auditoria.

Em todos os casos, os scripts rodam fora do hMailServer, sob um usu√°rio do Windows com as permiss√µes necess√°rias, e n√£o h√° execu√ß√£o de comandos externos a partir do `EventHandlers`.

---

## 11.5 Seguran√ßa e boas pr√°ticas dessa automa√ß√£o
‚úÖ **Nenhuma chave privada ou senha deve ser commitada no Git:**
* usar placeholders (`***SENHA***`), vari√°veis de ambiente ou algum mecanismo externo (ex.: Credential Manager) no servidor real.

‚úÖ **Scripts focam em:**
* consultar o reposit√≥rio de certificados;
* exportar arquivos;
* atualizar configura√ß√µes do hMailServer/IIS;
* gerar logs.

‚úÖ **N√£o h√°:**
* exposi√ß√£o de portas adicionais;
* chamadas remotas pelo hMailServer;
* manipula√ß√£o de rede al√©m do que j√° existe no servidor.

üîé **Em caso de problema:**
* o m√°ximo que acontece √© o hMailServer continuar usando o certificado antigo por algum tempo;
* a automa√ß√£o pode ser desativada simplesmente desabilitando a tarefa ou renomeando o script, sem impacto no fluxo normal de e-mail.

Com isso, a parte de certificados tamb√©m entra no ‚Äúpiloto autom√°tico‚Äù: Win-ACME renova, os scripts sincronizam, IIS e hMailServer seguem sempre com TLS atualizado ‚Äî sem precisar de a√ß√£o manual e sem expor segredos no reposit√≥rio p√∫blico.
